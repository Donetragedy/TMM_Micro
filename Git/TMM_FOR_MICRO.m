
%% Spectral measurement data
Si = importdata("Si.xlsx");
SiO2 = importdata('SiO2.xlsx');
Inter = importdata('SiO2_Si_interface_layer.xlsx'); %upload the dispersion

%picking measurement file (it should be in .txt format and the first row starts with "Measuremend data")
[file,path,indx] = uigetfile( ...
{'*.*',  'All Files (*.*)'}, ...
   'Select a File');

    bfile = importdata(fullfile(file));
    wl = bfile.data(:,1);
    Rp  = bfile.data(:,2);


% Angle weights
weights = [0	0.0714285714285714	0.142857142857143	0.214285714285714	0.285714285714286	0.357142857142857	0.428571428571428	0.500000000000000	0.571428571428571	0.642857142857143	0.714285714285714	0.785714285714286	0.857142857142857	0.928571428571429	1 0 0 0 0 0 0 0 0];

%% Spectral data fitting

% Functions
n_air = transpose(1+0.05792105/(238.0185-wl.^-2)+0.00167917/(57.362-wl.^-2)); % dispersion for air (real part)
n_fun = [n_air,zeros(length(wl),1)]; % dispersion complex (n and k which k=0). Its a array matrix. wl n k???

% we do the interpolation of the dispersion for each material.

Ms = mldm(wl,Si); %substrate
MSiO2 = mldm(wl,SiO2); %coating
MInter = mldm(wl,Inter);%interface


SiO2_th_min=1950; % lower bound
SiO2_th=2000; % expected value
SiO2_th_max=2090; % upper bound

Inter_th_min=0; % lower bound
Inter_th=0;  % expected value
Inter_th_max=0; % upper bound

%% Model structure 

%Refr ind matrix
first_layer_nk=MSiO2(:,2);  %1st layer above substrate with only n
refr_ind_matrix=[first_layer_nk];

%Thickness matrix
first_layer_d_min=SiO2_th_min;  %1st layer above substrate
Th_matrix_min=[first_layer_d_min];

first_layer_d= SiO2_th; %1st layer above substrate
Th_matrix=[first_layer_d];

first_layer_d_max=SiO2_th_max;  %1st layer above substrate
Th_matrix_max=[first_layer_d_max];


 
%% Fitting itself 

% Gaussian weights for the thickness variation
gauss_weights= [0.135335283236613	0.324652467358350	0.606530659712633	0.882496902584596	1	0.882496902584596	0.606530659712633	0.324652467358350	0.135335283236613];

% Fitting function
Rpfun = @(x) sum([ ((refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,0,'unpolarized')*weights(1)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,1.6929,'unpolarized')*weights(2)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,2.7557,'unpolarized')*weights(3)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,3.8304,'unpolarized')*weights(4)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,4.9069,'unpolarized')*weights(5)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,5.9821,'unpolarized')*weights(6)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,7.0541,'unpolarized')*weights(7)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,8.1219,'unpolarized')*weights(8)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,9.1845,'unpolarized')*weights(9)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,10.2410,'unpolarized')*weights(10)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,11.2907,'unpolarized')*weights(11)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,12.3329,'unpolarized')*weights(12)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,13.3671,'unpolarized')*weights(13)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,14.3925,'unpolarized')*weights(14)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,15.4087,'unpolarized')*weights(15)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,15.9075519305258,'unpolarized')*weights(16)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,16,'unpolarized')*weights(17)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,17,'unpolarized')*weights(18)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,18,'unpolarized')*weights(19)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,19,'unpolarized')*weights(20)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,20,'unpolarized')*weights(21)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,21,'unpolarized')*weights(22)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)],0,22,'unpolarized')*weights(23))/sum(weights)), ...
    ((refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,0,'unpolarized')*weights(1)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,1.6929,'unpolarized')*weights(2)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,2.7557,'unpolarized')*weights(3)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,3.8304,'unpolarized')*weights(4)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,4.9069,'unpolarized')*weights(5)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,5.9821,'unpolarized')*weights(6)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,7.0541,'unpolarized')*weights(7)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,8.1219,'unpolarized')*weights(8)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,9.1845,'unpolarized')*weights(9)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,10.2410,'unpolarized')*weights(10)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,11.2907,'unpolarized')*weights(11)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,12.3329,'unpolarized')*weights(12)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,13.3671,'unpolarized')*weights(13)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,14.3925,'unpolarized')*weights(14)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,15.4087,'unpolarized')*weights(15)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,15.9075519305258,'unpolarized')*weights(16)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,16,'unpolarized')*weights(17)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,17,'unpolarized')*weights(18)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,18,'unpolarized')*weights(19)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,19,'unpolarized')*weights(20)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,20,'unpolarized')*weights(21)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,21,'unpolarized')*weights(22)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-3*x(3)/4],0,22,'unpolarized')*weights(23))/sum(weights)), ...
    ((refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,0,'unpolarized')*weights(1)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,1.6929,'unpolarized')*weights(2)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,2.7557,'unpolarized')*weights(3)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,3.8304,'unpolarized')*weights(4)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,4.9069,'unpolarized')*weights(5)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,5.9821,'unpolarized')*weights(6)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,7.0541,'unpolarized')*weights(7)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,8.1219,'unpolarized')*weights(8)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,9.1845,'unpolarized')*weights(9)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,10.2410,'unpolarized')*weights(10)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,11.2907,'unpolarized')*weights(11)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,12.3329,'unpolarized')*weights(12)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,13.3671,'unpolarized')*weights(13)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,14.3925,'unpolarized')*weights(14)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,15.4087,'unpolarized')*weights(15)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,15.9075519305258,'unpolarized')*weights(16)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,16,'unpolarized')*weights(17)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,17,'unpolarized')*weights(18)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,18,'unpolarized')*weights(19)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,19,'unpolarized')*weights(20)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,20,'unpolarized')*weights(21)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,21,'unpolarized')*weights(22)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-2*x(3)/4],0,22,'unpolarized')*weights(23))/sum(weights)), ...
    ((refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,0,'unpolarized')*weights(1)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,1.6929,'unpolarized')*weights(2)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,2.7557,'unpolarized')*weights(3)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,3.8304,'unpolarized')*weights(4)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,4.9069,'unpolarized')*weights(5)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,5.9821,'unpolarized')*weights(6)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,7.0541,'unpolarized')*weights(7)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,8.1219,'unpolarized')*weights(8)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,9.1845,'unpolarized')*weights(9)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,10.2410,'unpolarized')*weights(10)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,11.2907,'unpolarized')*weights(11)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,12.3329,'unpolarized')*weights(12)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,13.3671,'unpolarized')*weights(13)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,14.3925,'unpolarized')*weights(14)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,15.4087,'unpolarized')*weights(15)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,15.9075519305258,'unpolarized')*weights(16)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,16,'unpolarized')*weights(17)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,17,'unpolarized')*weights(18)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,18,'unpolarized')*weights(19)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,19,'unpolarized')*weights(20)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,20,'unpolarized')*weights(21)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,21,'unpolarized')*weights(22)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)-x(3)/4],0,22,'unpolarized')*weights(23))/sum(weights)), ...
    ((refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,0,'unpolarized')*weights(1)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,1.6929,'unpolarized')*weights(2)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,2.7557,'unpolarized')*weights(3)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,3.8304,'unpolarized')*weights(4)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,4.9069,'unpolarized')*weights(5)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,5.9821,'unpolarized')*weights(6)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,7.0541,'unpolarized')*weights(7)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,8.1219,'unpolarized')*weights(8)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,9.1845,'unpolarized')*weights(9)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,10.2410,'unpolarized')*weights(10)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,11.2907,'unpolarized')*weights(11)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,12.3329,'unpolarized')*weights(12)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,13.3671,'unpolarized')*weights(13)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,14.3925,'unpolarized')*weights(14)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,15.4087,'unpolarized')*weights(15)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,15.9075519305258,'unpolarized')*weights(16)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,16,'unpolarized')*weights(17)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,17,'unpolarized')*weights(18)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,18,'unpolarized')*weights(19)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,19,'unpolarized')*weights(20)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,20,'unpolarized')*weights(21)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,21,'unpolarized')*weights(22)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)],0,22,'unpolarized')*weights(23))/sum(weights)), ...
    ((refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,0,'unpolarized')*weights(1)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,1.6929,'unpolarized')*weights(2)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,2.7557,'unpolarized')*weights(3)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,3.8304,'unpolarized')*weights(4)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,4.9069,'unpolarized')*weights(5)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,5.9821,'unpolarized')*weights(6)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,7.0541,'unpolarized')*weights(7)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,8.1219,'unpolarized')*weights(8)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,9.1845,'unpolarized')*weights(9)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,10.2410,'unpolarized')*weights(10)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,11.2907,'unpolarized')*weights(11)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,12.3329,'unpolarized')*weights(12)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,13.3671,'unpolarized')*weights(13)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,14.3925,'unpolarized')*weights(14)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,15.4087,'unpolarized')*weights(15)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,15.9075519305258,'unpolarized')*weights(16)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,16,'unpolarized')*weights(17)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,17,'unpolarized')*weights(18)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,18,'unpolarized')*weights(19)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,19,'unpolarized')*weights(20)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,20,'unpolarized')*weights(21)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,21,'unpolarized')*weights(22)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)/4],0,22,'unpolarized')*weights(23))/sum(weights)), ...
    ((refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,0,'unpolarized')*weights(1)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,1.6929,'unpolarized')*weights(2)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,2.7557,'unpolarized')*weights(3)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,3.8304,'unpolarized')*weights(4)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,4.9069,'unpolarized')*weights(5)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,5.9821,'unpolarized')*weights(6)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,7.0541,'unpolarized')*weights(7)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,8.1219,'unpolarized')*weights(8)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,9.1845,'unpolarized')*weights(9)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,10.2410,'unpolarized')*weights(10)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,11.2907,'unpolarized')*weights(11)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,12.3329,'unpolarized')*weights(12)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,13.3671,'unpolarized')*weights(13)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,14.3925,'unpolarized')*weights(14)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,15.4087,'unpolarized')*weights(15)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,15.9075519305258,'unpolarized')*weights(16)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,16,'unpolarized')*weights(17)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,17,'unpolarized')*weights(18)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,18,'unpolarized')*weights(19)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,19,'unpolarized')*weights(20)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,20,'unpolarized')*weights(21)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,21,'unpolarized')*weights(22)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+2*x(3)/4],0,22,'unpolarized')*weights(23))/sum(weights)), ...
    ((refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,0,'unpolarized')*weights(1)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,1.6929,'unpolarized')*weights(2)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,2.7557,'unpolarized')*weights(3)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,3.8304,'unpolarized')*weights(4)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,4.9069,'unpolarized')*weights(5)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,5.9821,'unpolarized')*weights(6)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,7.0541,'unpolarized')*weights(7)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,8.1219,'unpolarized')*weights(8)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,9.1845,'unpolarized')*weights(9)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,10.2410,'unpolarized')*weights(10)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,11.2907,'unpolarized')*weights(11)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,12.3329,'unpolarized')*weights(12)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,13.3671,'unpolarized')*weights(13)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,14.3925,'unpolarized')*weights(14)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,15.4087,'unpolarized')*weights(15)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,15.9075519305258,'unpolarized')*weights(16)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,16,'unpolarized')*weights(17)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,17,'unpolarized')*weights(18)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,18,'unpolarized')*weights(19)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,19,'unpolarized')*weights(20)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,20,'unpolarized')*weights(21)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,21,'unpolarized')*weights(22)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+3*x(3)/4],0,22,'unpolarized')*weights(23))/sum(weights)), ...
    ((refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,0,'unpolarized')*weights(1)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,1.6929,'unpolarized')*weights(2)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,2.7557,'unpolarized')*weights(3)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,3.8304,'unpolarized')*weights(4)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,4.9069,'unpolarized')*weights(5)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,5.9821,'unpolarized')*weights(6)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,7.0541,'unpolarized')*weights(7)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,8.1219,'unpolarized')*weights(8)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,9.1845,'unpolarized')*weights(9)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,10.2410,'unpolarized')*weights(10)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,11.2907,'unpolarized')*weights(11)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,12.3329,'unpolarized')*weights(12)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,13.3671,'unpolarized')*weights(13)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,14.3925,'unpolarized')*weights(14)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,15.4087,'unpolarized')*weights(15)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,15.9075519305258,'unpolarized')*weights(16)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,16,'unpolarized')*weights(17)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,17,'unpolarized')*weights(18)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,18,'unpolarized')*weights(19)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,19,'unpolarized')*weights(20)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,20,'unpolarized')*weights(21)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,21,'unpolarized')*weights(22)+ ...
    refl_mod_wl_v11(Ms,[MInter(:,2:3),[MSiO2(:,2),zeros(length(wl),1)]],[x(1),x(2)+x(3)],0,22,'unpolarized')*weights(23))/sum(weights))].*gauss_weights/ sum(gauss_weights),2);


%residual
resfun = @(x) Rp - Rpfun(x); 
merfun = @(x) norm(resfun(x))^2;

%fitting parameters
x0 = [Inter_th,Th_matrix, 5];
lb = [Inter_th_min,Th_matrix_min,0];
ub = [Inter_th_max,Th_matrix_max,100];

%fitting algorithm
fopts = optimoptions('lsqnonlin','Algorithm','trust-region-reflective',...
    'Display','off');
[xf,resnorm,resid,~,~,~,J] = lsqnonlin(resfun,x0,lb,ub,fopts);
ci = nlparci(xf,resid,'jacobian',J);
u = abs(xf - ci(:,1).'); %fitting process uncertainty

% Show results
display('Result:')
fprintf('%.3e +- %.3e\n',[xf;u])
Rpf = Rpfun(xf);
reflComp([wl,Rp],[wl,Rpf],'fnum',1)

fsfplots=20;

copy = [xf;u];  
openvar('copy')






